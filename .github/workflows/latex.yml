  name: Checkout
    uses: actions/checkout@v4
    with:
      fetch-depth: 0

  name: Build PDF (LaTeX)
    uses: xu-cheng/latex-action@v3
    with:
      root_file: A-New-Covenant-for-Learning.tex
      args: -pdf -interaction=nonstopmode -file-line-error -halt-on-error

  name: Prepare site (PDF, QR, OG image, index.html)
    run: |
      set -e
      mkdir -p public
      cp A-New-Covenant-for-Learning.pdf public/

      sudo apt-get update
      sudo apt-get install -y qrencode imagemagick

      PDF_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/A-New-Covenant-for-Learning.pdf"
      qrencode -o public/qr.png -s 12 -m 2 "${PDF_URL}"

      convert -size 1200x630 xc:white \
        -fill "#4054B2" -gravity North -pointsize 54 -annotate +0+60 "A New Covenant for Learning" \
        -fill "#333333" -gravity North -pointsize 36 -annotate +0+130 "From Compulsion to Concert" \
        public/qr.png -gravity SouthEast -geometry +60+60 -composite public/og-image.png

      cat > public/index.html <<'HTML'
      <!doctype html>
      <html lang="en">
      <head>
        <meta charset="utf-8">
        <title>A New Covenant for Learning: From Compulsion to Concert</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Mastery-first blueprint: Pact on Temporal Non-Aggression + Symphony of Agents + verifiable mastery on permissioned DLT.">
        <link rel="canonical" href="A-New-Covenant-for-Learning.pdf">
        <meta property="og:title" content="A New Covenant for Learning: From Compulsion to Concert">
        <meta property="og:description" content="From homework to a Symphony of Agents. Read the paper.">
        <meta property="og:type" content="article">
        <meta property="og:image" content="og-image.png">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="A New Covenant for Learning">
        <meta name="twitter:description" content="Mastery-first, low-stress learning.">
        <meta name="twitter:image" content="og-image.png">
        <style>
          body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:0;padding:2rem 1rem;line-height:1.5;color:#222}
          .wrap{max-width:880px;margin:0 auto;text-align:center}
          h1{font-weight:700;margin:0 0 0.5rem}
          p{margin:0.5rem 0 1rem}
          .btn{display:inline-block;background:#4054B2;color:#fff;padding:0.6rem 1rem;border-radius:8px;text-decoration:none;margin:0.25rem}
          img{max-width:200px;margin-top:1rem;opacity:0.9}
        </style>
      </head>
      <body>
        <div class="wrap">
          <h1>A New Covenant for Learning</h1>
          <p>From Compulsion to Concert • Mastery-first • Symphony of Agents • Permissioned DLT</p>
          <p>
            <a class="btn" href="A-New-Covenant-for-Learning.pdf">Open PDF</a>
            <a class="btn" href="https://raw.githubusercontent.com/${{ github.repository }}/main/docs/citation.bib">Cite (BibTeX)</a>
          </p>
          <img src="qr.png" alt="QR code to the PDF">
        </div>
      </body>
      </html>
      HTML

  name: Configure Pages
    uses: actions/configure-pages@v5

  name: Upload artifact
    uses: actions/upload-pages-artifact@v3
    with:
      path: ./public

  name: Deploy to GitHub Pages
    id: deployment
    uses: actions/deploy-pages@v4
